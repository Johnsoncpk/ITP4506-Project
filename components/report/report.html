<div class="page-content">
    <div class="container-fluid">
        <h2 id="title">Report</h2>
        <hr />
        <div class="row gutters-sm">
            <div class="col-md-12 py-3">
                <div class="row">
                    <div class="col-md-12 py-3">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Period
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <a class="dropdown-item" href="#">2021</a>
                                <a class="dropdown-item" href="#">2020</a>
                                <a class="dropdown-item" href="#">2019</a>
                                <a class="dropdown-item" href="#">2018</a>
                                <a class="dropdown-item" href="#">2017</a>
                                <a class="dropdown-item" href="#">2016</a>
                                <a class="dropdown-item" href="#">2015</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card p-0">
                    <table class="table table-striped">
                        <thead>
                            <tr id="data">
                                <th scope="col" id="name">Name</th>
                                <th scope="col" id="className">Class</th>
                                <th scope="col">Present</th>
                                <th scope="col">Late</th>
                                <th scope="col">Early Leave</th>
                                <th scope="col">Sick Leave</th>
                                <th scope="col">Personal leave</th>
                                <th scope="col">Absent Without Reason</th>
                                <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody id="table"></tbody>
                    </table>
                </div>

                <div class="row">
                    <div class="col-md-12 py-3" style="height: 300px;">
                        <div id="container" style="width: 100%; height: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <hr />
        <footer class="text-center">
            <div class="mb-2">
                <small>
                    Â© 2021 made by -
                    <a target="_blank" rel="noopener noreferrer" href="https://www.ive.edu.hk/ivesite/html/tc/">
                        Ive Jai
                    </a>
                </small>
            </div>
        </footer>
    </div>
</div>


<script>

    $(document).ready(function () {


        function drawChart() {
            anychart.onDocumentReady(function () {
                if ($("#dropdownMenuButton").text() == "2021") {
                    rows = [
                        ["Monday", 79],
                        ["Tuesday", 89],
                        ["Wednesday", 100],
                        ["Thursday", 100],
                        ["Friday", 88],
                    ];
                } else if ($("#dropdownMenuButton").text() == "2020") {
                    rows = [
                        ["Monday", 98.6],
                        ["Tuesday", 99.3],
                        ["Wednesday", 100],
                        ["Thursday", 100],
                        ["Friday", 89.5],
                    ];
                } else {
                    rows = [
                        ["Monday", 77.6],
                        ["Tuesday", 99.3],
                        ["Wednesday", 98],
                        ["Thursday", 89.8],
                        ["Friday", 89.5],
                    ];
                }

                // set the data
                var data = {
                    header: ["Name", "Percentage"],
                    rows: rows
                };
                // create the chart
                chart = anychart.column();

                // add the data
                chart.data(data);

                // set the chart title
                chart.title("Attendance Record");

                // draw
                chart.container("container");
                chart.draw();
            });
        }

        let searchParams = new URLSearchParams(window.location.search)
        var url = "";
        var studentId = "";
        if (localStorage.getItem("role") == "student") {
            studentId = localStorage.getItem("id");
        } else {
            studentId = searchParams.get('studentId');
        }
        //alert(searchParams.get('type'));
        var type = searchParams.get('type');
        var className = searchParams.get('className');

        if (className == "") {
            className = "2B";
        }


        if (type == "student") {
            url = "http://127.0.0.1/ITP4506/Attendance-Online-Server/genReport/genReport-student.php";
        } else if (type == "class") {
            url = "http://127.0.0.1/ITP4506/Attendance-Online-Server/genReport/genReport-class.php";
        } else {
            url = "http://127.0.0.1/ITP4506/Attendance-Online-Server/genReport/genReport-school.php";
        }

        if (type == "class") {
            $("#title").text("Class Report");
            $("#name").remove();
            $(".dropdown").remove();
            loadData();
        } else if (type == "school") {
            $("#title").text("School Report");
            $("#name").remove();
            $("#className").remove();
            loadData();
        } else {
            $("#title").text("Student Report");
            $(".dropdown").remove();
        }



        async function loadData() {

            var result = "";
            var rows = [];
            var name = "";
            var classReceived = "";
            var studentIdReceived = "";
            $("#container").empty();
            $(".rowData").empty();


            if (type == "student") {
                $.ajax({
                    type: "post",
                    url: url,
                    async: false,
                    data: {
                        "userID": studentId,
                    },
                    success: function (data, status, xhr) {
                        console.log(data[0]);

                        //if ($("#dropdownMenuButton").text() == "Year") {

                        rows = [
                            ["Present", data[0].present.toFixed(2)],
                            ["Late", data[0].late.toFixed(2)],
                            ["Early Leave", data[0].earlyLeave.toFixed(2)],
                            ["Sick Leave", data[0].sickLeave.toFixed(2)],
                            ["Personal leave", data[0].personalLeave.toFixed(2)],
                            ["Absent Without Reason", data[0].absentWithoutReason.toFixed(2)]
                        ];
                        /*} else {
                            rows = [
                                ["Present", 90],
                                ["Late", 5],
                                ["Early Leave", 0],
                                ["Sick Leave", 5],
                                ["Personal leave", 0],
                                ["Absent Without Reason", 0]
                            ];
                        }*/
                        name = data[0].student;
                        classReceived = data[0].class;
                        studentIdReceived = data[0].studentId;

                    },
                    error: function (jqXhr, textStatus, errorMessage) {
                    }
                });

            } else if (type == "class") {
                $.ajax({
                    type: "post",
                    url: url,
                    async: false,
                    data: {
                        class: className,
                    },
                    success: function (data, status, xhr) {
                        console.log(data[0]);
                        rows = [
                            ["Present", data[0].present.toFixed(2)],
                            ["Late", data[0].late.toFixed(2)],
                            ["Early Leave", data[0].earlyLeave.toFixed(2)],
                            ["Sick Leave", data[0].sickLeave.toFixed(2)],
                            ["Personal leave", data[0].personalLeave.toFixed(2)],
                            ["Absent Without Reason", data[0].absentWithoutReason.toFixed(2)]
                        ];
                        classReceived = data[0].class;

                    },
                    error: function (jqXhr, textStatus, errorMessage) {
                    }
                });
            } else {
                $.ajax(
                    url,
                    {
                        async: false,
                        dataType: "json",
                        timeout: 500,
                        success: function (data, status, xhr) {
                            console.log(data[0]);


                            if ($("#dropdownMenuButton").text() == "2021") {

                                rows = [
                                    ["Present", data[0].present.toFixed(2)],
                                    ["Late", data[0].late.toFixed(2)],
                                    ["Early Leave", data[0].earlyLeave.toFixed(2)],
                                    ["Sick Leave", data[0].sickLeave.toFixed(2)],
                                    ["Personal leave", data[0].personalLeave.toFixed(2)],
                                    ["Absent Without Reason", data[0].absentWithoutReason.toFixed(2)]
                                ];
                            } else if ($("#dropdownMenuButton").text() == "2020") {
                                rows = [
                                    ["Present", 87.6],
                                    ["Late", 8.3],
                                    ["Early Leave", 1.7],
                                    ["Sick Leave", 2.4],
                                    ["Personal leave", 0],
                                    ["Absent Without Reason", 0]
                                ];
                            } else {
                                rows = [
                                    ["Present", 90],
                                    ["Late", 5],
                                    ["Early Leave", 0],
                                    ["Sick Leave", 5],
                                    ["Personal leave", 0],
                                    ["Absent Without Reason", 0]
                                ];
                            }
                        },
                        error: function (jqXhr, textStatus, errorMessage) {
                        },
                    }
                );
            }

            if (type == "student") {
                result += `<tr class="rowData">
                <td>`+ name + `</td>
                <td>` + classReceived + `</td>`
            } else if (type == "class") {
                result += `<tr class="rowData">
                    <td>`+ classReceived + `</td>`
            } else {
                result += `<tr class="rowData">`
            }
            result +=
                `
                <td>`+ rows[0][1] + `%</td>
                <td>`+ rows[1][1] + `%</td>
                <td>`+ rows[2][1] + `%</td>
                <td>`+ rows[3][1] + `%</td>
                <td>`+ rows[4][1] + `%</td>
                <td>`+ rows[5][1] + `%</td>`


            if (type == "student") {
                result += `<td>
                    <a class="btn btn-info mr-1" href="./attendance.html?studentId=`+ studentIdReceived + `
                    " id="edit">Detail</a>
                </td>
             </tr>`
            } else if (type == "class") {
                result += `</tr>`
            }
            $("#data").after(result);
            drawChart();
        }

        $(".dropdown-item").click(function (event) {
            $("#dropdownMenuButton").text($(this).text());
            loadData();
        });


        $("#query").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#table tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });
    });
</script>